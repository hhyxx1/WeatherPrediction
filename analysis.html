<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±åº¦å¤©æ°”åˆ†æ - æ™ºèƒ½å¤©æ°”é¢„æŠ¥</title>
    <script src="weatherApiConfig.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- è°·æ­Œå­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* è‡ªå®šä¹‰CSSå˜é‡ */
        :root {
            --primary-color: #0ea5e9;
            --secondary-color: #3b82f6;
            --primary-light: #7dd3fc;
            --card-background: rgba(255, 255, 255, 0.7);
            --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
            min-height: 100vh;
            color: #1e293b;
            overflow-x: hidden;
        }
        
        /* ç»ç’ƒæ€æ•ˆæœ */
        .glass-effect {
            background: var(--card-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
        }
        
        .glass-effect:hover {
            box-shadow: var(--shadow-medium);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        /* æµ®åŠ¨ç²’å­èƒŒæ™¯ */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            animation: floatUp linear infinite;
        }
        
        @keyframes floatUp {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.4;
            }
            90% {
                opacity: 0.4;
            }
            100% {
                transform: translateY(-20vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* åˆ†æå¡ç‰‡æ ·å¼ */
        .analysis-card {
            background: var(--card-background);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .analysis-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        
        .analysis-card:hover::before {
            transform: scaleX(1);
        }
        
        /* åˆ†æç»“æœæ ·å¼ */
        .analysis-result {
            line-height: 1.8;
            color: #475569;
        }
        
        .analysis-result p {
            margin-bottom: 1rem;
        }
        
        .analysis-result h4 {
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* åŸå¸‚é€‰æ‹©å™¨æ ·å¼ */
        .city-selector {
            transition: all 0.3s ease;
        }
        
        .city-selector:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        /* åˆ†ææŒ‰é’®æ ·å¼ */
        .analyze-button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .analyze-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.4);
        }
        
        .analyze-button:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }
        
        /* æ•°æ®åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(14, 165, 233, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            height: 400px;
            width: 100%;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            
            .analysis-card {
                border-radius: 12px;
            }
        }
        
        /* å¯¼èˆªé“¾æ¥æ ·å¼ */
        nav a {
            position: relative;
            transition: all 0.3s ease;
        }
        
        nav a::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-light);
            transition: width 0.3s ease;
        }
        
        nav a:hover::after, nav a.text-blue-600::after {
            width: 100%;
        }
    </style>
</head>
<body class="overflow-x-hidden">
    <!-- æµ®åŠ¨ç²’å­èƒŒæ™¯ -->
    <div class="floating-particles">
        <div class="particle w-2 h-2" style="left: 10%; animation-delay: 0s; animation-duration: 20s;"></div>
        <div class="particle w-3 h-3" style="left: 20%; animation-delay: 1s; animation-duration: 25s;"></div>
        <div class="particle w-1 h-1" style="left: 30%; animation-delay: 2s; animation-duration: 15s;"></div>
        <div class="particle w-2 h-2" style="left: 40%; animation-delay: 3s; animation-duration: 22s;"></div>
        <div class="particle w-3 h-3" style="left: 50%; animation-delay: 4s; animation-duration: 18s;"></div>
        <div class="particle w-1 h-1" style="left: 60%; animation-delay: 5s; animation-duration: 24s;"></div>
        <div class="particle w-2 h-2" style="left: 70%; animation-delay: 0.5s; animation-duration: 16s;"></div>
        <div class="particle w-3 h-3" style="left: 80%; animation-delay: 1.5s; animation-duration: 21s;"></div>
        <div class="particle w-1 h-1" style="left: 90%; animation-delay: 2.5s; animation-duration: 19s;"></div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="glass-effect fixed top-0 left-0 right-0 z-50 px-4 py-3">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="weather-icon">ğŸŒ¤ï¸</div>
                <h1 class="text-lg md:text-2xl font-bold text-slate-800" style="font-family: 'Noto Serif SC', serif;">
                    å…¨çƒå¤©æ°”æ•°æ®åˆ†æç³»ç»Ÿ
                </h1>
            </div>
            
            <div class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-slate-700 hover:text-blue-600 font-medium transition-colors">
                    å®æ—¶ç›‘æ§
                </a>
                <a href="analysis.html" class="text-blue-600 font-medium">
                    æ·±åº¦åˆ†æ
                </a>
                <a href="about.html" class="text-slate-700 hover:text-blue-600 font-medium transition-colors">
                    å…³äºç³»ç»Ÿ
                </a>
            </div>
            
            <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
            <div class="md:hidden">
                <button onclick="toggleMobileMenu()" class="text-slate-700 hover:text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- ç§»åŠ¨ç«¯èœå• -->
        <div id="mobileMenu" class="hidden md:hidden mt-4 pb-4 border-t border-slate-200">
            <div class="flex flex-col space-y-3 pt-4">
                <a href="index.html" class="text-slate-700 hover:text-blue-600 font-medium transition-colors px-2">
                    å®æ—¶ç›‘æ§
                </a>
                <a href="analysis.html" class="text-blue-600 font-medium px-2">
                    æ·±åº¦åˆ†æ
                </a>
                <a href="about.html" class="text-slate-700 hover:text-blue-600 font-medium transition-colors px-2">
                    å…³äºç³»ç»Ÿ
                </a>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="pt-20 px-4 pb-12">
        <div class="max-w-7xl mx-auto">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="text-center mb-10">
                <h2 class="text-3xl md:text-4xl font-bold text-slate-800 mb-4" style="font-family: 'Noto Serif SC', serif;">
                    å¤©æ°”æ·±åº¦åˆ†æ
                </h2>
                <p class="text-slate-600 max-w-2xl mx-auto">
                    åŸºäºAIæŠ€æœ¯çš„å¤©æ°”æ•°æ®æ·±åº¦åˆ†æï¼Œä¸ºæ‚¨æä¾›æ›´ç²¾å‡†çš„å¤©æ°”è¶‹åŠ¿æ´å¯Ÿå’Œé¢„æµ‹å»ºè®®
                </p>
            </div>

            <!-- åŸå¸‚æœç´¢ç»„ä»¶ - ç§»åˆ°bodyç›´æ¥å­å…ƒç´ ä½ç½®ä»¥é¿å…å±‚çº§é—®é¢˜ -->
            <div class="relative z-1000 mb-6">
                <label for="citySearch" class="block text-sm font-medium text-slate-700 mb-1">
                    æœç´¢åŸå¸‚
                </label>
                <div class="relative" style="position: relative; z-index: 9999;">
                    <input 
                        type="text" 
                        id="citySearch" 
                        placeholder="è¾“å…¥åŸå¸‚åç§°..."
                        class="city-selector bg-white/80 backdrop-blur-sm border border-slate-300 rounded-lg px-4 py-2 w-full text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        oninput="handleCitySearch()"
                    >
                    <div id="citySearchResults" class="hidden fixed z-9999 left-0 right-0 mx-auto w-full max-w-md mt-1 bg-white/95 backdrop-blur-sm border border-slate-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        <!-- æœç´¢ç»“æœä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                </div>
                <div id="selectedCityInfo" class="mt-2 text-sm text-slate-600 hidden">
                    å·²é€‰æ‹©: <span id="selectedCityName">åŒ—äº¬</span>
                    <button id="changeCityBtn" class="ml-2 text-blue-600 hover:text-blue-800">æ›´æ¢</button>
                </div>
                <input type="hidden" id="selectedCityId" value="101010100">
            </div>
            
            <!-- åˆ†ææ§åˆ¶ -->
            <div class="glass-effect rounded-2xl p-6 mb-8">
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
                    <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-6">

                        <!-- æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">
                                åˆ†ææ—¶é—´èŒƒå›´ (å¹´)
                            </label>
                            <div class="flex items-center space-x-2">
                                <input 
                                    type="range" 
                                    id="timeRangeSlider" 
                                    min="1" 
                                    max="30" 
                                    value="10"
                                    class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                >
                                <span id="timeRangeValue" class="text-sm font-medium text-slate-700 min-w-[30px]">10</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">æ‹–åŠ¨æ»‘å—é€‰æ‹©1-30å¹´çš„åˆ†æèŒƒå›´</p>
                        </div>

                        <!-- AIé¢„æµ‹å¤©æ•°é€‰æ‹©å™¨ -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">
                                AIé¢„æµ‹å¤©æ•° (å¤©)
                            </label>
                            <div class="flex items-center space-x-2">
                                <input 
                                    type="range" 
                                    id="predictionDaysSlider" 
                                    min="1" 
                                    max="14" 
                                    value="3"
                                    class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-purple-600"
                                >
                                <span id="predictionDaysValue" class="text-sm font-medium text-slate-700 min-w-[30px]">3</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">æ‹–åŠ¨æ»‘å—é€‰æ‹©1-14å¤©çš„AIé¢„æµ‹èŒƒå›´</p>
                        </div>
                    </div>

                    <!-- åˆ†æå’Œå¯¼å‡ºæŒ‰é’® -->
                    <div class="flex space-x-3">
                        <button id="analyzeButton" class="analyze-button" onclick="analyzeWeatherData()">
                            <i class="fa fa-bar-chart mr-2"></i>å¼€å§‹åˆ†æ
                        </button>
                        <button id="exportButton" class="analyze-button bg-green-600 hover:bg-green-700 hidden" onclick="exportAnalysisData()">
                            <i class="fa fa-download mr-2"></i>å¯¼å‡ºæ•°æ®
                        </button>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState" class="hidden flex flex-col items-center justify-center py-20">
                <div class="loading-spinner mb-4"></div>
                <p class="text-slate-700">æ­£åœ¨è·å–å¤©æ°”æ•°æ®å¹¶è¿›è¡Œæ·±åº¦åˆ†æ...</p>
            </div>

            <!-- åˆ†æç»“æœåŒºåŸŸ -->
            <div id="analysisResults" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- åˆ†ææ¦‚è¿°å¡ç‰‡ -->
                <div class="lg:col-span-1 analysis-card p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">
                        <i class="fa fa-lightbulb-o text-yellow-500 mr-2"></i>åˆ†ææ¦‚è¿°
                    </h3>
                    <div id="analysisSummary" class="analysis-result">
                        <p class="text-slate-500 italic">è¯·é€‰æ‹©åŸå¸‚å¹¶ç‚¹å‡»å¼€å§‹åˆ†ææŒ‰é’®æŸ¥çœ‹ç»“æœ</p>
                    </div>
                </div>

                <!-- è¯¦ç»†åˆ†æå¡ç‰‡ -->
                <div class="lg:col-span-2 analysis-card p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">
                        <i class="fa fa-area-chart text-blue-500 mr-2"></i>è¯¦ç»†åˆ†æ
                    </h3>
                    <div id="detailedAnalysis" class="analysis-result">
                        <p class="text-slate-500 italic">åˆ†æç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- æ¸©åº¦è¶‹åŠ¿å›¾è¡¨ -->
                <div class="analysis-card p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">
                        <i class="fa fa-thermometer-half text-red-500 mr-2"></i>æ¸©åº¦è¶‹åŠ¿åˆ†æ
                    </h3>
                    <div id="temperatureChart" class="chart-container"></div>
                </div>

                <!-- é™æ°´æ¦‚ç‡å›¾è¡¨ -->
                <div class="analysis-card p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">
                        <i class="fa fa-tint text-blue-500 mr-2"></i>é™æ°´æ¦‚ç‡åˆ†æ
                    </h3>
                    <div id="precipitationChart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        }

        // å…¨å±€é…ç½®å¯¹è±¡ï¼Œä½¿ç”¨weatherApiConfig.jsä¸­çš„é…ç½®
        const config = {
            weatherApi: {
                baseUrl: window.WEATHER_CONFIG?.weatherApi?.baseUrl || 'https://devapi.qweather.com/v7',
                key: window.WEATHER_CONFIG?.weatherApi?.key || 'YOUR_API_KEY',
                geoApiUrl: window.WEATHER_CONFIG?.weatherApi?.geoBaseUrl || 'https://geoapi.qweather.com/v2'
            },
            deepseekApi: {
                baseUrl: window.WEATHER_CONFIG?.aiApi?.baseUrl || 'https://api.deepseek.com/v1',
                apiKey: window.WEATHER_CONFIG?.aiApi?.key || 'YOUR_API_KEY'
            },
            currentCity: {
                id: '101020100',
                name: 'ä¸Šæµ·'
            }
        };

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            // ä»URLå‚æ•°æˆ–localStorageè·å–åŸå¸‚ä¿¡æ¯
            const urlParams = new URLSearchParams(window.location.search);
            const cityId = urlParams.get('cityId');
            const cityName = urlParams.get('cityName');
            
            if (cityId && cityName) {
                // ä»URLå‚æ•°è·å–ï¼ˆä»é¦–é¡µè·³è½¬è¿‡æ¥ï¼‰
                config.currentCity = { id: cityId, name: cityName };
                setSelectedCity(cityId, cityName);
            } else {
                // æ£€æŸ¥localStorageæ˜¯å¦æœ‰ä¿å­˜çš„åŸå¸‚
                const savedCity = localStorage.getItem('selectedCity');
                if (savedCity) {
                    const parsedCity = JSON.parse(savedCity);
                    config.currentCity = parsedCity;
                    setSelectedCity(parsedCity.id, parsedCity.name);
                } else {
                    // é»˜è®¤åŸå¸‚ä¸ºä¸Šæµ·
                    config.currentCity = { id: '101020100', name: 'ä¸Šæµ·' };
                    setSelectedCity('101020100', 'ä¸Šæµ·');
                }
            }

            // åˆå§‹åŒ–æ—¶é—´èŒƒå›´æ»‘å—
            const slider = document.getElementById('timeRangeSlider');
            const valueDisplay = document.getElementById('timeRangeValue');
            slider.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
            });

            // åˆå§‹åŒ–AIé¢„æµ‹å¤©æ•°æ»‘å—
            const predictionSlider = document.getElementById('predictionDaysSlider');
            const predictionValueDisplay = document.getElementById('predictionDaysValue');
            predictionSlider.addEventListener('input', function() {
                predictionValueDisplay.textContent = this.value;
            });

            // åˆå§‹åŒ–æ›´æ¢åŸå¸‚æŒ‰é’®
            document.getElementById('changeCityBtn').addEventListener('click', function() {
                document.getElementById('citySearch').classList.remove('hidden');
                document.getElementById('selectedCityInfo').classList.add('hidden');
                document.getElementById('citySearch').focus();
            });

            // åˆå§‹åŒ–å›¾è¡¨
            initCharts();
        }

        // è®¾ç½®é€‰ä¸­çš„åŸå¸‚
        function setSelectedCity(cityId, cityName) {
            document.getElementById('selectedCityId').value = cityId;
            document.getElementById('selectedCityName').textContent = cityName;
            document.getElementById('selectedCityInfo').classList.remove('hidden');
            document.getElementById('citySearch').classList.add('hidden');
            document.getElementById('citySearchResults').classList.add('hidden');
        }

        // å¤„ç†åŸå¸‚æœç´¢
        async function handleCitySearch() {
            const searchTerm = document.getElementById('citySearch').value.trim();
            const resultsContainer = document.getElementById('citySearchResults');
            
            if (searchTerm.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }

            try {
                // ä½¿ç”¨å’Œé£å¤©æ°”çš„åœ°ç†ç¼–ç APIæœç´¢åŸå¸‚
                const url = `${config.weatherApi.geoApiUrl}/city/lookup?location=${encodeURIComponent(searchTerm)}&key=${config.weatherApi.key}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.code === '200' && data.location && data.location.length > 0) {
                    // æ˜¾ç¤ºæœç´¢ç»“æœ
                    resultsContainer.innerHTML = '';
                    data.location.slice(0, 10).forEach(city => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer transition-colors';
                        resultItem.innerHTML = `
                            <div class="font-medium">${city.name}</div>
                            <div class="text-xs text-slate-500">${city.adminArea || ''}${city.country || ''}</div>
                        `;
                        resultItem.addEventListener('click', () => {
                            config.currentCity = { id: city.id, name: city.name };
                            localStorage.setItem('selectedCity', JSON.stringify(config.currentCity));
                            setSelectedCity(city.id, city.name);
                        });
                        resultsContainer.appendChild(resultItem);
                    });
                    resultsContainer.classList.remove('hidden');
                } else {
                    resultsContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error('åŸå¸‚æœç´¢å¤±è´¥:', error);
                resultsContainer.classList.add('hidden');
            }
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
        document.addEventListener('click', function(event) {
            const searchContainer = document.querySelector('#citySearch').parentElement;
            const resultsContainer = document.getElementById('citySearchResults');
            
            if (!searchContainer.contains(event.target)) {
                resultsContainer.classList.add('hidden');
            }
        });

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // æ¸©åº¦è¶‹åŠ¿å›¾è¡¨
            const temperatureChart = echarts.init(document.getElementById('temperatureChart'));
            temperatureChart.setOption({
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#ddd',
                    textStyle: { color: '#333' }
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '10%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: [],
                    axisLine: { lineStyle: { color: '#ddd' } },
                    axisLabel: { color: '#666' }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ¸©åº¦ (Â°C)',
                    nameTextStyle: { color: '#666' },
                    axisLine: { lineStyle: { color: '#ddd' } },
                    axisLabel: { color: '#666' },
                    splitLine: { lineStyle: { color: '#f0f0f0' } }
                },
                series: [{
                    name: 'æ¸©åº¦',
                    type: 'line',
                    data: [],
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    itemStyle: { color: '#ff7e67' },
                    areaStyle: { color: 'rgba(255, 126, 103, 0.1)' },
                    lineStyle: { width: 3 }
                }]
            });

            // é™æ°´æ¦‚ç‡å›¾è¡¨
            const precipitationChart = echarts.init(document.getElementById('precipitationChart'));
            precipitationChart.setOption({
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#ddd',
                    textStyle: { color: '#333' }
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '10%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: [],
                    axisLine: { lineStyle: { color: '#ddd' } },
                    axisLabel: { color: '#666' }
                },
                yAxis: {
                    type: 'value',
                    name: 'é™æ°´æ¦‚ç‡ (%)',
                    nameTextStyle: { color: '#666' },
                    axisLine: { lineStyle: { color: '#ddd' } },
                    axisLabel: { color: '#666' },
                    splitLine: { lineStyle: { color: '#f0f0f0' } },
                    max: 100
                },
                series: [{
                    name: 'é™æ°´æ¦‚ç‡',
                    type: 'line',
                    data: [],
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    itemStyle: { color: '#7dd3fc' },
                    areaStyle: { color: 'rgba(125, 211, 252, 0.1)' },
                    lineStyle: { width: 3 }
                }]
            });

            // å“åº”å¼è°ƒæ•´
            window.addEventListener('resize', () => {
                temperatureChart.resize();
                precipitationChart.resize();
            });
        }

        // åˆ†æå¤©æ°”æ•°æ®
            async function analyzeWeatherData() {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('analysisResults').classList.add('hidden');
                
                // è·å–é€‰æ‹©çš„åŸå¸‚ã€æ—¶é—´èŒƒå›´å’ŒAIé¢„æµ‹å¤©æ•°
                const cityId = document.getElementById('selectedCityId').value;
                const cityName = document.getElementById('selectedCityName').textContent;
                const days = parseInt(document.getElementById('timeRangeSlider').value);
                const predictionDays = parseInt(document.getElementById('predictionDaysSlider').value);
                const timeRange = `${days}d`;
                
                config.currentCity = { id: cityId, name: cityName };
                localStorage.setItem('selectedCity', JSON.stringify(config.currentCity));
                
                try {
                    // è·å–å¤©æ°”æ•°æ®
                    const weatherData = await fetchWeatherData(cityId, timeRange);
                    
                    // ä½¿ç”¨DeepSeek APIè·å–é¢„æµ‹æ•°æ®
                    const predictionData = await getAIPredictionData(weatherData, cityName, predictionDays);
                    
                    // ä½¿ç”¨DeepSeek APIè¿›è¡Œæ·±åº¦åˆ†æ
                    const analysisResult = await analyzeWithDeepSeek(weatherData, cityName, days);
                    
                    // ä¿å­˜æ•°æ®ç”¨äºå¯¼å‡º
                    currentWeatherData = weatherData;
                    currentPredictionData = predictionData;
                    currentAnalysisData = analysisResult;
                    
                    // æ›´æ–°å›¾è¡¨ï¼ŒåŒ…æ‹¬é¢„æµ‹æ•°æ®
                    updateCharts(weatherData, predictionData);
                    
                    // æ˜¾ç¤ºåˆ†æç»“æœ
                    displayAnalysisResults(analysisResult);
                } catch (error) {
                    console.error('åˆ†æå¤±è´¥:', error);
                    document.getElementById('analysisSummary').innerHTML = `<p class="text-red-500">åˆ†æå¤±è´¥: ${error.message}</p>`;
                    document.getElementById('detailedAnalysis').innerHTML = `<p class="text-red-500">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•</p>`;
                    // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®ï¼Œä½†åªä¼šå¯¼å‡ºå¯ç”¨çš„æ•°æ®
                    document.getElementById('exportButton').classList.remove('hidden');
                } finally {
                    // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºç»“æœ
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('analysisResults').classList.remove('hidden');
                }
            }

        // è·å–å¤©æ°”æ•°æ® - æ ¹æ®éœ€è¦é€‰æ‹©ä¸åŒçš„API
        async function fetchWeatherData(cityId, timeRange, apiType = null) {
            // é‡è¦ï¼šç¡®ä¿é¦–é¡µåªä½¿ç”¨å’Œé£å¤©æ°”APIï¼Œé¿å…è°ƒç”¨Open Meteo Archive API
            // ä»å½“å‰é¡µé¢URLåˆ¤æ–­æ˜¯å¦åœ¨analysisé¡µé¢
            const isAnalysisPage = window.location.pathname.includes('analysis.html');
            
            // å¦‚æœæœªæŒ‡å®šAPIç±»å‹ï¼Œä½¿ç”¨é…ç½®ä¸­çš„é»˜è®¤API
            const finalApiType = apiType || (config.weatherApi && config.weatherApi.defaultApi) || (isAnalysisPage ? 'openmeteo' : 'qweather');
            
            // é‡è¦ï¼šé¦–é¡µ(index.html)å¼ºåˆ¶ä½¿ç”¨å’Œé£å¤©æ°”API
            if (!isAnalysisPage) {
                console.log('é¦–é¡µå¼ºåˆ¶ä½¿ç”¨å’Œé£å¤©æ°”API');
                if (config.weatherApi && config.weatherApi.qweather) {
                    return await fetchQWeatherData(cityId, timeRange);
                }
                // å¦‚æœå’Œé£å¤©æ°”APIæœªé…ç½®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                console.warn('å’Œé£å¤©æ°”APIæœªé…ç½®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®');
                return generateMockWeatherData(cityId, timeRange);
            }
            
            // å¯¹äºanalysisé¡µé¢çš„å†å¹´åŒå¤©æ•°æ®åˆ†æï¼Œä½¿ç”¨Open Meteo API
            if (finalApiType === 'openmeteo' || (typeof timeRange === 'string' && timeRange.includes('d') && parseInt(timeRange.replace('d', '')) > 7)) {
                return await fetchOpenMeteoData(cityId, timeRange);
            } 
            // å¯¹äºå®æ—¶æ•°æ®ï¼Œä½¿ç”¨å’Œé£å¤©æ°”APIï¼ˆå¦‚æœé…ç½®äº†ï¼‰
            else if (finalApiType === 'qweather' && config.weatherApi && config.weatherApi.qweather) {
                return await fetchQWeatherData(cityId, timeRange);
            }
            
            // analysisé¡µé¢é»˜è®¤ä½¿ç”¨Open Meteo API
            console.warn(`æœªé…ç½®æŒ‡å®šçš„APIç±»å‹: ${finalApiType}ï¼Œå°†ä½¿ç”¨Open Meteo APIä½œä¸ºåå¤‡`);
            return await fetchOpenMeteoData(cityId, timeRange);
        }
        
        // ä»Open Meteo APIè·å–å†å²å¤©æ°”æ•°æ® - è·å–å†å¹´åŒå¤©æ•°æ®
        async function fetchOpenMeteoData(cityId, timeRange) {
            // æå–å¹´æ•°
            let years = parseInt(timeRange.replace('d', ''));
            
            // è®¾ç½®æœ€å¤§å¹´æ•°ä¸º30å¹´
            const MAX_YEARS = 30;
            if (years > MAX_YEARS) {
                console.log(`è¯·æ±‚${years}å¹´æ•°æ®ï¼Œå·²è°ƒæ•´ä¸º${MAX_YEARS}å¹´`);
                years = MAX_YEARS;
            }
            
            try {
                // é¦–å…ˆé€šè¿‡åŸå¸‚IDè·å–ç»çº¬åº¦ï¼ˆå¦‚æœcityIdä¸æ˜¯ç»çº¬åº¦æ ¼å¼ï¼‰
                let latitude, longitude;
                if (cityId.includes(',')) {
                    // å¦‚æœcityIdå·²ç»æ˜¯ç»çº¬åº¦æ ¼å¼ "lat,lon"
                    [latitude, longitude] = cityId.split(',').map(coord => parseFloat(coord));
                } else {
                    // å¦åˆ™éœ€è¦é€šè¿‡åœ°ç†ç¼–ç APIè·å–ç»çº¬åº¦
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥å®ç°å®Œæ•´çš„åœ°ç†ç¼–ç é€»è¾‘
                    console.log('éœ€è¦å®ç°åœ°ç†ç¼–ç åŠŸèƒ½å°†åŸå¸‚IDè½¬æ¢ä¸ºç»çº¬åº¦');
                    // ä¸´æ—¶ä½¿ç”¨é»˜è®¤ç»çº¬åº¦ï¼ˆåŒ—äº¬ï¼‰
                    latitude = 39.9042;
                    longitude = 116.4074;
                }
                
                // è®¡ç®—éœ€è¦è·å–çš„å†å¹´åŒå¤©æ•°æ®
                const today = new Date();
                const currentMonth = today.getMonth(); // 0-11
                const currentDay = today.getDate();
                
                const historicalData = [];
                
                // è·å–è¿‡å»å‡ å¹´çš„åŒä¸€å¤©æ•°æ®
                for (let i = 1; i <= years; i++) {
                    const targetYear = today.getFullYear() - i;
                    let targetDate = new Date(targetYear, currentMonth, currentDay);
                    
                    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆï¼ˆå¤„ç†é—°å¹´2æœˆ29æ—¥çš„æƒ…å†µï¼‰
                    if (targetDate.getMonth() !== currentMonth || targetDate.getDate() !== currentDay) {
                        // å¦‚æœæ˜¯2æœˆ29æ—¥ä¸”éé—°å¹´ï¼Œåˆ™ä½¿ç”¨3æœˆ1æ—¥
                        targetDate = new Date(targetYear, 2, 1); // 3æœˆ1æ—¥
                    }
                    
                    // è®¡ç®—è¿ç»­å¤šå¤©çš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ
                    const year = targetDate.getFullYear();
                    const startDateObj = new Date(targetDate);
                    const endDateObj = new Date(targetDate);
                    // ä»timeRangeä¸­è§£æå¤©æ•°ï¼Œé»˜è®¤ä¸º5å¤©
                    const days = parseInt(timeRange.replace('d', '')) || 5;
                    endDateObj.setDate(targetDate.getDate() + (days - 1)); // è·å–é€‰æ‹©çš„å¤©æ•°çš„æ•°æ®
                    
                    // æ ¼å¼åŒ–æ—¥æœŸä¸ºyyyy-MM-dd
                    const formatDate = (date) => {
                        const m = String(date.getMonth() + 1).padStart(2, '0');
                        const d = String(date.getDate()).padStart(2, '0');
                        return `${date.getFullYear()}-${m}-${d}`;
                    };
                    
                    const startDate = formatDate(startDateObj);
                    const endDate = formatDate(endDateObj); // æ ¹æ®é€‰æ‹©å™¨å¤©æ•°è·å–æ•°æ®
                    
                    // æ„å»ºOpen Meteo APIè¯·æ±‚URL - ä½¿ç”¨é…ç½®ä¸­çš„openMeteoå¯¹è±¡
                    const openMeteoConfig = config.openMeteo || { baseUrl: 'https://archive-api.open-meteo.com/v1/archive' };
                    const url = `${openMeteoConfig.baseUrl}?latitude=${latitude}&longitude=${longitude}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
                    
                    console.log(`è·å–å†å¹´åŒå¤©å†å²å¤©æ°”æ•°æ®ï¼Œæ—¥æœŸ: ${startDate}ï¼ŒURL: ${url}`);
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        console.warn(`è·å–${startDate}çš„å†å²å¤©æ°”æ•°æ®å¤±è´¥: ${response.status}`);
                        continue;
                    }
                    
                    const data = await response.json();
                    
                    // å¤„ç†è¿”å›çš„å¤šå¤©æ•°æ®
                    if (data.daily && data.daily.time && data.daily.time.length > 0) {
                        // éå†æ¯ä¸€å¤©çš„æ•°æ®
                        for (let j = 0; j < data.daily.time.length; j++) {
                            const dayData = {
                                fxDate: data.daily.time[j], // æ—¥æœŸ (yyyy-MM-dd)
                                tempMax: Math.round(data.daily.temperature_2m_max[j]).toString(), // æœ€é«˜æ¸©åº¦
                                tempMin: Math.round(data.daily.temperature_2m_min[j]).toString(), // æœ€ä½æ¸©åº¦
                                precip: Math.round(data.daily.precipitation_sum[j]).toString(), // é™æ°´é‡
                                humidity: Math.round(60 + Math.random() * 20).toString(), // æ¨¡æ‹Ÿæ¹¿åº¦æ•°æ®
                                pressure: Math.round(1013 + (Math.random() - 0.5) * 20).toString() // æ¨¡æ‹Ÿæ°”å‹æ•°æ®
                            };
                            
                            historicalData.push(dayData);
                        }
                    }
                }
                
                // å¦‚æœæœªèƒ½è·å–åˆ°ä»»ä½•å†å²æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿçš„å†å¹´æ•°æ®
                if (historicalData.length === 0) {
                    console.log('æœªèƒ½è·å–å®é™…å†å²æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿçš„å†å¹´åŒå¤©æ•°æ®');
                    return generateMockHistoricalData(years, currentMonth + 1, currentDay);
                }
                
                // è¿”å›æŒ‰å¹´ä»½æ­£åºæ’åˆ—çš„å†å²æ•°æ®ï¼ˆä»æœ€è¿œå¹´ä»½åˆ°æœ€è¿‘å¹´ä»½ï¼‰
                return historicalData.sort((a, b) => new Date(a.fxDate) - new Date(b.fxDate));
                
            } catch (error) {
                console.error('è·å–å†å²å¤©æ°”æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                const today = new Date();
                return generateMockHistoricalData(years, today.getMonth() + 1, today.getDate());
            }
        }
        
        // ä»å’Œé£å¤©æ°”APIè·å–å¤©æ°”æ•°æ® - ç”¨äºå®æ—¶ç›‘æ§
        async function fetchQWeatherData(cityId, timeRange) {
            // æå–å¤©æ•°
            const days = parseInt(timeRange.replace('d', ''));
            
            try {
                // ç¡®ä¿é…ç½®äº†å’Œé£å¤©æ°”API
                if (!config.weatherApi || !config.weatherApi.baseUrl || !config.weatherApi.key) {
                    console.error('å’Œé£å¤©æ°”APIé…ç½®ä¸å®Œæ•´');
                    throw new Error('å’Œé£å¤©æ°”APIé…ç½®ä¸å®Œæ•´');
                }
                
                const qweatherConfig = config.weatherApi;
                
                // æ„å»ºå’Œé£å¤©æ°”APIè¯·æ±‚URL - ä½¿ç”¨æ­£ç¡®çš„é…ç½®å­—æ®µå
                const url = `${qweatherConfig.baseUrl}/weather/${days}d?location=${cityId}&key=${qweatherConfig.key}`;
                
                console.log(`è·å–å’Œé£å¤©æ°”æ•°æ®ï¼ŒåŸå¸‚ID: ${cityId}ï¼Œæ—¶é—´èŒƒå›´: ${timeRange}ï¼ŒURL: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`è·å–å’Œé£å¤©æ°”æ•°æ®å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                
                // æ£€æŸ¥è¿”å›æ•°æ®æ˜¯å¦æ­£å¸¸
                if (data.code !== '200' || !data.daily) {
                    throw new Error(`å’Œé£å¤©æ°”APIè¿”å›é”™è¯¯: ${data.code || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                // å¤„ç†å’Œé£å¤©æ°”è¿”å›çš„æ•°æ®æ ¼å¼
                const weatherData = data.daily.map(day => ({
                    fxDate: day.fxDate, // æ—¥æœŸ
                    tempMax: day.tempMax, // æœ€é«˜æ¸©åº¦
                    tempMin: day.tempMin, // æœ€ä½æ¸©åº¦
                    precip: day.precip || '0', // é™æ°´é‡
                    humidity: day.humidity || Math.round(60 + Math.random() * 20).toString(), // æ¹¿åº¦ï¼ˆå¦‚æœæ²¡æœ‰åˆ™æ¨¡æ‹Ÿï¼‰
                    pressure: Math.round(1013 + (Math.random() - 0.5) * 20).toString() // æ¨¡æ‹Ÿæ°”å‹æ•°æ®
                }));
                
                return weatherData;
                
            } catch (error) {
                console.error('è·å–å’Œé£å¤©æ°”æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡
                return generateMockWeatherData(days);
            }
        }
        
        // ç”Ÿæˆæ¨¡æ‹Ÿçš„å¤©æ°”æ•°æ®ï¼ˆå½“å’Œé£å¤©æ°”APIæ— æ³•æä¾›æ•°æ®æ—¶ä½¿ç”¨ï¼‰
        function generateMockWeatherData(dayCount) {
            const mockData = [];
            const today = new Date();
            
            for (let i = 0; i < dayCount; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                // ç”Ÿæˆéšæœºä½†åˆç†çš„æ¸©åº¦
                const baseTemp = 20 + (Math.random() - 0.5) * 10;
                const tempMax = Math.round(baseTemp + 5 + Math.random() * 3).toString();
                const tempMin = Math.round(baseTemp - 5 - Math.random() * 3).toString();
                const precip = Math.round(Math.random() * 50).toString(); // 0-50mmçš„éšæœºé™æ°´é‡
                const humidity = Math.round(40 + Math.random() * 40).toString(); // 40-80%çš„éšæœºæ¹¿åº¦
                const pressure = Math.round(1005 + Math.random() * 20).toString(); // 1005-1025hPaçš„éšæœºæ°”å‹
                
                mockData.push({
                    fxDate: dateStr,
                    tempMax: tempMax,
                    tempMin: tempMin,
                    precip: precip,
                    humidity: humidity,
                    pressure: pressure
                });
            }
            
            return mockData;
        }
        
        // ç”Ÿæˆæ¨¡æ‹Ÿçš„å†å¹´åŒå¤©å†å²æ•°æ®ï¼ˆå½“APIæ— æ³•æä¾›å†å²æ•°æ®æ—¶ä½¿ç”¨ï¼‰
        function generateMockHistoricalData(yearCount, month, day) {
            const mockData = [];
            const baseYear = new Date().getFullYear() - 1; // ä»å»å¹´å¼€å§‹
            
            // åŸºäºå­£èŠ‚çš„æ¸©åº¦åŸºç¡€å€¼ï¼ˆåŒ—åŠçƒï¼‰
            let baseTempMax, baseTempMin, basePrecip;
            if ((month >= 3 && month <= 5)) { // æ˜¥å­£
                baseTempMax = 22 + Math.random() * 5;
                baseTempMin = 10 + Math.random() * 5;
                basePrecip = 40 + Math.random() * 20;
            } else if ((month >= 6 && month <= 8)) { // å¤å­£
                baseTempMax = 30 + Math.random() * 5;
                baseTempMin = 22 + Math.random() * 5;
                basePrecip = 60 + Math.random() * 20;
            } else if ((month >= 9 && month <= 11)) { // ç§‹å­£
                baseTempMax = 20 + Math.random() * 5;
                baseTempMin = 8 + Math.random() * 5;
                basePrecip = 30 + Math.random() * 20;
            } else { // å†¬å­£
                baseTempMax = 8 + Math.random() * 5;
                baseTempMin = -5 + Math.random() * 10;
                basePrecip = 20 + Math.random() * 15;
            }
            
            // ç”Ÿæˆæ¯ä¸€å¹´çš„æ•°æ®ï¼Œæ·»åŠ ä¸€å®šçš„éšæœºæ³¢åŠ¨å’Œå°è¶‹åŠ¿
            for (let i = 1; i <= yearCount; i++) {
                const year = baseYear - (i - 1);
                
                // æ·»åŠ å°çš„é€å¹´è¶‹åŠ¿ï¼ˆæ¨¡æ‹Ÿæ°”å€™å˜åŒ–ï¼‰
                const yearTrend = 0.2 * (i - 1); // æ¯å¹´æ¸©åº¦ä¸Šå‡0.2åº¦
                
                // ç”Ÿæˆéšæœºæ³¢åŠ¨çš„å€¼
                const tempMax = Math.round(baseTempMax + yearTrend + (Math.random() - 0.5) * 5);
                const tempMin = Math.round(baseTempMin + yearTrend + (Math.random() - 0.5) * 5);
                const precip = Math.round(basePrecip + (Math.random() - 0.5) * 20);
                const humidity = Math.round(60 + (Math.random() - 0.5) * 20);
                const pressure = Math.round(1013 + (Math.random() - 0.5) * 20);
                
                // æ ¼å¼åŒ–ä¸ºæ—¥æœŸå­—ç¬¦ä¸²
                const monthStr = String(month).padStart(2, '0');
                const dayStr = String(day).padStart(2, '0');
                const dateStr = `${year}${monthStr}${dayStr}`;
                
                mockData.push({
                    fxDate: dateStr,
                    tempMax: tempMax.toString(),
                    tempMin: tempMin.toString(),
                    precip: Math.max(0, Math.min(100, precip)).toString(),
                    humidity: humidity.toString(),
                    pressure: pressure.toString()
                });
            }
            
            return mockData;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸä¸ºyyyyMMdd
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // ä½¿ç”¨DeepSeek APIè·å–AIé¢„æµ‹æ•°æ®
        async function getAIPredictionData(historicalData, cityName, predictionDays) {
            // å‡†å¤‡å‘é€ç»™DeepSeekçš„æç¤ºä¿¡æ¯ï¼Œè¦æ±‚é¢„æµ‹æœªæ¥å‡ å¤©çš„å¤©æ°”
            const currentYear = new Date().getFullYear();
            const prompt = `ä»¥ä¸‹æ˜¯å¯¹${cityName}æœ€è¿‘${Object.keys(historicalData).length}å¤©å†å²å¤©æ°”æ•°æ®çš„æ·±åº¦åˆ†æç»“æœã€‚è¯·åŸºäºè¿™äº›å†å²æ•°æ®ï¼Œé¢„æµ‹æœªæ¥${predictionDays}å¤©çš„å¤©æ°”æƒ…å†µã€‚
            è¯·æ³¨æ„ï¼šæä¾›çš„æ•°æ®æ˜¯å†å²æ•°æ®ï¼Œä¸æ˜¯æœªæ¥æ•°æ®ã€‚é¢„æµ‹åº”åŸºäºå†å²æ•°æ®çš„æ¨¡å¼å’Œè¶‹åŠ¿è¿›è¡Œã€‚
            è¯·è¿”å›ç»“æ„åŒ–çš„JSONæ•°æ®ï¼ŒåªåŒ…å«é¢„æµ‹ç»“æœï¼Œä¸è¦å…¶ä»–æ–‡å­—è¯´æ˜ã€‚
            æ¯ä¸ªé¢„æµ‹ç»“æœéœ€è¦åŒ…å«ï¼šæ—¥æœŸ(fxDate)ã€æœ€é«˜æ¸©åº¦(tempMax)ã€æœ€ä½æ¸©åº¦(tempMin)ã€é™æ°´æ¦‚ç‡(precip)ã€‚
            é¢„æµ‹æ—¥æœŸåº”ä»å†å²æ•°æ®çš„æœ€åä¸€å¤©ä¹‹åå¼€å§‹ï¼Œå¹¶ä¸”å¹´ä»½å¿…é¡»ä¸º${currentYear}å¹´ã€‚
            
            å†å²æ•°æ®ï¼š${JSON.stringify(historicalData)}
            
            è¯·è¿”å›æ ¼å¼å¦‚ä¸‹çš„JSONæ•°æ®ï¼š
            [{"fxDate":"${currentYear}-01-01","tempMax":"20","tempMin":"10","precip":"30"},...]
            `;
            
            try {
                // è°ƒç”¨DeepSeek API
                const response = await fetch(`${config.deepseekApi.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.deepseekApi.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('è°ƒç”¨DeepSeek APIå¤±è´¥');
                }
                
                const data = await response.json();
                const predictionText = data.choices[0].message.content;
                
                // å°è¯•è§£æJSONæ•°æ®
                try {
                    const predictions = JSON.parse(predictionText);
                    return predictions.slice(0, predictionDays); // ç¡®ä¿åªè¿”å›è¯·æ±‚çš„å¤©æ•°
                } catch (parseError) {
                    console.error('è§£æé¢„æµ‹æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', parseError);
                    // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    return generateMockPredictionData(historicalData, predictionDays);
                }
            } catch (error) {
                console.error('è·å–AIé¢„æµ‹æ•°æ®å¤±è´¥:', error);
                // è¿”å›æ¨¡æ‹Ÿé¢„æµ‹æ•°æ®
                return generateMockPredictionData(historicalData, predictionDays);
            }
        }
        
        // ç”Ÿæˆæ¨¡æ‹Ÿé¢„æµ‹æ•°æ®ï¼ˆå½“APIè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
        function generateMockPredictionData(historicalData, days) {
            const predictions = [];
            
            // ä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸ºé¢„æµ‹çš„å¼€å§‹æ—¥æœŸï¼Œç¡®ä¿é¢„æµ‹å¹´ä»½ä¸ºå½“å¹´
            const today = new Date();
            const currentYear = today.getFullYear();
            console.log('ä½¿ç”¨å½“å‰å¹´ä»½è¿›è¡Œé¢„æµ‹:', currentYear);
            
            // è®¡ç®—å†å²æ•°æ®çš„å¹³å‡æ¸©åº¦å’Œé™æ°´æ¦‚ç‡ï¼Œç”¨äºç”Ÿæˆåˆç†çš„é¢„æµ‹
            let avgMaxTemp = 0;
            let avgMinTemp = 0;
            let avgPrecip = 0;
            
            historicalData.forEach(item => {
                avgMaxTemp += parseInt(item.tempMax);
                avgMinTemp += parseInt(item.tempMin);
                avgPrecip += parseInt(item.precip) || 0;
            });
            
            avgMaxTemp = avgMaxTemp / historicalData.length;
            avgMinTemp = avgMinTemp / historicalData.length;
            avgPrecip = avgPrecip / historicalData.length;
            
            // ç”Ÿæˆé¢„æµ‹æ•°æ®
            for (let i = 0; i < days; i++) {
                // ä»ä»Šå¤©å¼€å§‹é¢„æµ‹
                const predictionDate = new Date(today);
                predictionDate.setDate(today.getDate() + i);
                
                // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å½“å‰å¹´ä»½
                predictionDate.setFullYear(currentYear);
                
                // ç”Ÿæˆéšæœºæ³¢åŠ¨çš„æ¸©åº¦å’Œé™æ°´æ¦‚ç‡
                const tempMax = Math.round(avgMaxTemp + (Math.random() - 0.5) * 10);
                const tempMin = Math.round(avgMinTemp + (Math.random() - 0.5) * 10);
                const precip = Math.round(avgPrecip + (Math.random() - 0.5) * 30);
                
                predictions.push({
                    fxDate: predictionDate.toISOString().split('T')[0],
                    tempMax: Math.max(tempMin + 1, tempMax).toString(),
                    tempMin: tempMin.toString(),
                    precip: Math.max(0, Math.min(100, precip)).toString()
                });
            }
            
            return predictions;
        }
        
        // ä½¿ç”¨DeepSeek APIè¿›è¡Œæ·±åº¦åˆ†æ
        async function analyzeWithDeepSeek(weatherData, cityName, years) {
            // å‡†å¤‡å‘é€ç»™DeepSeekçš„æç¤ºä¿¡æ¯ï¼Œæ˜ç¡®è¯´æ˜æ˜¯å†å¹´åŒå¤©çš„æ•°æ®
            const prompt = `è¯·å¯¹${cityName}å†å¹´åŒä¸€å¤©ï¼ˆæœ€è¿‘${years}å¹´ï¼‰çš„å¤©æ°”æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æï¼ŒåŒ…æ‹¬ï¼š
            1. æ¸©åº¦è¶‹åŠ¿åˆ†æï¼ˆæœ€é«˜æ¸©ã€æœ€ä½æ¸©ã€æ¸©å·®å˜åŒ–åŠå¹´é™…å˜åŒ–è§„å¾‹ï¼‰
            2. é™æ°´æƒ…å†µåˆ†æï¼ˆå†å¹´åŒä¸€å¤©çš„é™æ°´æ¨¡å¼ï¼‰
            3. æ°”å€™å˜åŒ–è¶‹åŠ¿ï¼ˆåŸºäºå†å¹´æ•°æ®çš„é•¿æœŸå˜åŒ–æ¨¡å¼ï¼‰
            4. ç»™ç”¨æˆ·çš„å­£èŠ‚æ€§å‡ºè¡Œå»ºè®®
            5. åŸºäºå†å²æ¨¡å¼çš„ç‰¹æ®Šå¤©æ°”æé†’

            åŸå§‹æ•°æ®ï¼š${JSON.stringify(weatherData)}

            è¯·è¿”å›ç»“æ„åŒ–çš„åˆ†æç»“æœï¼ŒåŒ…æ‹¬æ¦‚è¿°å’Œè¯¦ç»†åˆ†æä¸¤éƒ¨åˆ†ã€‚
            åœ¨åˆ†æä¸­æ˜ç¡®æŒ‡å‡ºè¿™æ˜¯å¯¹å†å¹´åŒä¸€å¤©å†å²æ•°æ®çš„åˆ†æï¼Œé‡ç‚¹å…³æ³¨å¹´é™…å˜åŒ–è§„å¾‹å’Œå­£èŠ‚æ€§ç‰¹å¾ã€‚`;
            
            try {
                // è°ƒç”¨DeepSeek API
                const response = await fetch(`${config.deepseekApi.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.deepseekApi.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('è°ƒç”¨DeepSeek APIå¤±è´¥');
                }
                
                const data = await response.json();
                const analysisText = data.choices[0].message.content;
                
                // è§£æåˆ†æç»“æœ
                // è¿™é‡Œä½¿ç”¨ç®€åŒ–çš„è§£æé€»è¾‘ï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„å¤„ç†
                const result = {
                    summary: analysisText.substring(0, analysisText.indexOf('è¯¦ç»†åˆ†æ')),
                    details: analysisText.substring(analysisText.indexOf('è¯¦ç»†åˆ†æ'))
                };
                
                return result;
            } catch (error) {
                console.error('DeepSeek APIè°ƒç”¨å¤±è´¥:', error);
                
                // è¿”å›æ¨¡æ‹Ÿåˆ†æç»“æœï¼ˆå½“APIä¸å¯ç”¨æ—¶ï¼‰
                return {
                    summary: `
                        <p><strong>${cityName}</strong>å¤©æ°”åˆ†ææ¦‚è¦ï¼š</p>
                        <p>æ ¹æ®æœ€è¿‘${years}å¹´åŒä¸€å¤©çš„å†å²å¤©æ°”æ•°æ®åˆ†æï¼Œè¯¥åœ°åŒºè¯¥æ—¥å¹³å‡æ°”æ¸©${Math.random() > 0.5 ? 'å‘ˆé€å¹´ä¸Šå‡è¶‹åŠ¿ï¼Œç¬¦åˆå…¨çƒå˜æš–è§„å¾‹' : 'ç›¸å¯¹ç¨³å®šï¼Œä½†å­˜åœ¨ä¸€å®šå¹´é™…æ³¢åŠ¨'}ã€‚é™æ°´æ¨¡å¼${Math.random() > 0.5 ? 'è¾ƒä¸ºä¸€è‡´ï¼Œé€šå¸¸é™æ°´æ¦‚ç‡è¾ƒä½' : 'å˜åŒ–è¾ƒå¤§ï¼Œå¹´é™…é—´å·®å¼‚æ˜æ˜¾'}ã€‚</p>
                        <p>åŸºäºå¤šå¹´å†å²æ•°æ®ï¼Œä»Šå¹´è¯¥æ—¥å¤©æ°”å¯èƒ½${Math.random() > 0.5 ? 'è¾ƒå¾€å¹´åæš–' : 'æ¥è¿‘å†å²å¹³å‡æ°´å¹³'}ï¼Œå»ºè®®å…³æ³¨æœ€æ–°å¤©æ°”é¢„æŠ¥å¹¶ç»“åˆå†å²è¶‹åŠ¿è¿›è¡Œå‚è€ƒã€‚</p>
                    `,
                    details: `
                        <h4>æ¸©åº¦è¶‹åŠ¿åˆ†æ</h4>
                        <p>æ ¹æ®å¯¹æœ€è¿‘${years}å¹´åŒä¸€å¤©å†å²æ•°æ®çš„åˆ†æï¼Œè¯¥æ—¥å¹³å‡æ°”æ¸©ä¸º${Math.floor(Math.random() * 10) + 15}Â°Cï¼Œæœ€é«˜æ¸©åº¦${Math.floor(Math.random() * 10) + 25}Â°Cï¼Œæœ€ä½æ¸©åº¦${Math.floor(Math.random() * 10) + 5}Â°Cã€‚</p>
                        <p>è§‚å¯Ÿ${years}å¹´æ•°æ®ï¼Œå‘ç°è¯¥æ—¥æ¸©åº¦${Math.random() > 0.5 ? 'å‘ˆç°æ˜æ˜¾ä¸Šå‡è¶‹åŠ¿ï¼Œå¹³å‡æ¯å¹´å‡é«˜çº¦0.2Â°C' : 'å˜åŒ–ç›¸å¯¹ç¨³å®šï¼Œä¸»è¦å—å½“å¹´æ°”å€™ç³»ç»Ÿå½±å“'}ã€‚</p>
                        <p>å†å²æ•°æ®æ˜¾ç¤ºï¼Œè¯¥æ—¥æ¸©å·®å¹³å‡ä¸º${Math.floor(Math.random() * 10) + 8}Â°Cï¼Œ${Math.random() > 0.5 ? 'è¾ƒå…¶ä»–æ—¥æœŸåå¤§' : 'å¤„äºæ­£å¸¸èŒƒå›´å†…'}ã€‚</p>
                        
                        <h4>é™æ°´æƒ…å†µåˆ†æ</h4>
                        <p>åœ¨è¿‡å»${years}å¹´ä¸­ï¼Œè¯¥æ—¥é™æ°´æ¦‚ç‡å¹³å‡ä¸º${Math.floor(Math.random() * 40) + 20}%ï¼Œ${Math.random() > 0.5 ? 'é™æ°´æ—¥æ•°ç›¸å¯¹è¾ƒå°‘' : 'æœ‰ä¸€å®šé™æ°´å¯èƒ½æ€§'}ã€‚</p>
                        <p>é™æ°´æ¨¡å¼${Math.random() > 0.5 ? 'å‘ˆç°ä¸€å®šå‘¨æœŸæ€§å˜åŒ–ï¼Œå¯èƒ½ä¸å„å°”å°¼è¯º/æ‹‰å°¼å¨œç°è±¡ç›¸å…³' : 'ç›¸å¯¹éšæœºï¼Œä¸»è¦å—å½“å¹´å¤§æ°”ç¯æµå½±å“'}ã€‚</p>
                        
                        <h4>æ°”å€™å˜åŒ–è¶‹åŠ¿</h4>
                        <p>åˆ†æ${years}å¹´æ•°æ®ï¼Œè¯¥æ—¥å¤©æ°”${Math.random() > 0.5 ? 'æ˜¾ç¤ºå‡ºæ˜æ˜¾çš„æ°”å€™å˜åŒ–ä¿¡å·ï¼Œå¦‚æ¸©åº¦ä¸Šå‡ã€æç«¯å¤©æ°”äº‹ä»¶é¢‘ç‡å¢åŠ ' : 'å˜åŒ–ç›¸å¯¹è¾ƒå°ï¼Œä½†é•¿æœŸè¶‹åŠ¿ä»ç¬¦åˆå…¨çƒæ°”å€™å˜æš–æ–¹å‘'}ã€‚</p>
                        
                        <h4>å­£èŠ‚æ€§å‡ºè¡Œå»ºè®®</h4>
                        <p>æ ¹æ®å†å¹´åŒä¸€å¤©æ•°æ®ï¼Œ${Math.random() > 0.5 ? 'è¯¥æ—¥å¤©æ°”é€šå¸¸é€‚åˆæˆ·å¤–æ´»åŠ¨ï¼Œä½†éœ€æ³¨æ„é˜²æ™’å’Œæ¸©åº¦å˜åŒ–' : 'å»ºè®®æºå¸¦é›¨å…·ï¼Œåšå¥½å¤©æ°”å¤šå˜çš„å‡†å¤‡'}ã€‚</p>
                        <p>å†å²æ°”æ¸©æ³¢åŠ¨è¡¨æ˜ï¼Œ${Math.random() > 0.5 ? 'ç€è£…åº”é€‰æ‹©çµæ´»å¯å¢å‡çš„è¡£ç‰©ç»„åˆï¼Œä»¥é€‚åº”å¯èƒ½çš„æ¸©åº¦å˜åŒ–' : 'è¯¥æ—¥æ¸©å·®è¾ƒå°ï¼Œå¯ä»¥ç›¸å¯¹å›ºå®šåœ°å®‰æ’ç€è£…'}ã€‚</p>
                    `
                };
            }
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts(weatherData, predictionData = []) {
            const temperatureChart = echarts.getInstanceByDom(document.getElementById('temperatureChart'));
            const precipitationChart = echarts.getInstanceByDom(document.getElementById('precipitationChart'));
            
            // å‡†å¤‡å†å²æ•°æ®
            const historicalDates = [];
            const historicalTemperatures = [];
            const historicalPrecipitations = [];
            
            weatherData.forEach(item => {
                // æ ¼å¼åŒ–æ—¥æœŸ
                const date = new Date(item.fxDate);
                const dateStr = `${date.getMonth() + 1}-${date.getDate()}`;
                historicalDates.push(dateStr);
                
                // æ·»åŠ æ¸©åº¦æ•°æ®ï¼ˆä½¿ç”¨æœ€é«˜æ¸©å’Œæœ€ä½æ¸©çš„å¹³å‡å€¼ï¼‰
                const avgTemp = (parseInt(item.tempMax) + parseInt(item.tempMin)) / 2;
                historicalTemperatures.push(avgTemp);
                
                // æ·»åŠ é™æ°´æ¦‚ç‡æ•°æ®
                historicalPrecipitations.push(parseInt(item.precip) || Math.floor(Math.random() * 50));
            });
            
            // å‡†å¤‡é¢„æµ‹æ•°æ®
            const predictionDates = [];
            const predictionTemperatures = [];
            const predictionPrecipitations = [];
            
            predictionData.forEach(item => {
                // æ ¼å¼åŒ–æ—¥æœŸ
                const date = new Date(item.fxDate);
                const dateStr = `${date.getMonth() + 1}-${date.getDate()}`;
                predictionDates.push(dateStr);
                
                // æ·»åŠ æ¸©åº¦æ•°æ®ï¼ˆä½¿ç”¨æœ€é«˜æ¸©å’Œæœ€ä½æ¸©çš„å¹³å‡å€¼ï¼‰
                const avgTemp = (parseInt(item.tempMax) + parseInt(item.tempMin)) / 2;
                predictionTemperatures.push(avgTemp);
                
                // æ·»åŠ é™æ°´æ¦‚ç‡æ•°æ®
                predictionPrecipitations.push(parseInt(item.precip) || Math.floor(Math.random() * 50));
            });
            
            // åˆå¹¶æ—¥æœŸæ•°ç»„
            const allDates = [...historicalDates, ...predictionDates];
            
            // æ›´æ–°æ¸©åº¦å›¾è¡¨
            temperatureChart.setOption({
                xAxis: { data: allDates },
                series: [
                    {
                        name: 'å†å²æ¸©åº¦',
                        type: 'line',
                        data: historicalTemperatures,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: { color: '#ff7e67' },
                        areaStyle: { color: 'rgba(255, 126, 103, 0.1)' },
                        lineStyle: { width: 3 }
                    },
                    predictionData.length > 0 ? {
                        name: 'é¢„æµ‹æ¸©åº¦',
                        type: 'line',
                        // ä½¿ç”¨å†å²æ•°æ®çš„æœ€åä¸€ä¸ªç‚¹ä½œä¸ºé¢„æµ‹æ•°æ®çš„èµ·ç‚¹ï¼Œç¡®ä¿è¿æ¥
                        data: [...new Array(historicalDates.length - 1).fill(null), historicalTemperatures[historicalTemperatures.length - 1], ...predictionTemperatures],
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: { color: '#ff7e67' },
                        lineStyle: { 
                            width: 3,
                            type: 'dashed',
                            opacity: 0.8
                        },
                        areaStyle: { 
                            color: 'rgba(255, 126, 103, 0.05)'
                        }
                    } : {}
                ].filter(item => Object.keys(item).length > 0)
            });
            
            // æ›´æ–°é™æ°´æ¦‚ç‡å›¾è¡¨
            precipitationChart.setOption({
                xAxis: { data: allDates },
                series: [
                    {
                        name: 'å†å²é™æ°´æ¦‚ç‡',
                        type: 'line',
                        data: historicalPrecipitations,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: { color: '#7dd3fc' },
                        areaStyle: { color: 'rgba(125, 211, 252, 0.1)' },
                        lineStyle: { width: 3 }
                    },
                    predictionData.length > 0 ? {
                        name: 'é¢„æµ‹é™æ°´æ¦‚ç‡',
                        type: 'line',
                        // ä½¿ç”¨å†å²æ•°æ®çš„æœ€åä¸€ä¸ªç‚¹ä½œä¸ºé¢„æµ‹æ•°æ®çš„èµ·ç‚¹ï¼Œç¡®ä¿è¿æ¥
                        data: [...new Array(historicalDates.length - 1).fill(null), historicalPrecipitations[historicalPrecipitations.length - 1], ...predictionPrecipitations],
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: { color: '#7dd3fc' },
                        lineStyle: { 
                            width: 3,
                            type: 'dashed',
                            opacity: 0.8
                        },
                        areaStyle: { 
                            color: 'rgba(125, 211, 252, 0.05)'
                        }
                    } : {}
                ].filter(item => Object.keys(item).length > 0)
            });
        }

        // å­˜å‚¨åˆ†ææ•°æ®ï¼Œç”¨äºå¯¼å‡º
            let currentAnalysisData = null;
            let currentWeatherData = null;
            let currentPredictionData = null;
            
            // æ˜¾ç¤ºåˆ†æç»“æœ
            function displayAnalysisResults(result) {
                document.getElementById('analysisSummary').innerHTML = result.summary || '<p>æš‚æ— åˆ†æç»“æœ</p>';
                document.getElementById('detailedAnalysis').innerHTML = result.details || '<p>æš‚æ— è¯¦ç»†åˆ†æ</p>';
                // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
                document.getElementById('exportButton').classList.remove('hidden');
            }
            
            // å¯¼å‡ºåˆ†ææ•°æ®
            function exportAnalysisData() {
                if (!currentAnalysisData && !currentWeatherData) {
                    alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆè¿›è¡Œåˆ†æ');
                    return;
                }
                
                // æ˜¾ç¤ºæ ¼å¼é€‰æ‹©å¯¹è¯æ¡†
                const format = prompt('è¯·é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š\n1. CSVæ ¼å¼ï¼ˆå¤©æ°”æ•°æ®è¡¨æ ¼ï¼‰\n2. JSONæ ¼å¼ï¼ˆå®Œæ•´åˆ†ææŠ¥å‘Šï¼‰\n\nè¯·è¾“å…¥ 1 æˆ– 2', '1');
                
                if (!format || (format !== '1' && format !== '2')) {
                    console.log('ç”¨æˆ·å–æ¶ˆå¯¼å‡º');
                    return;
                }
                
                if (format === '1') {
                    // å¯¼å‡ºä¸ºCSVæ ¼å¼
                    exportWeatherDataAsCSV();
                } else {
                    // å¯¼å‡ºä¸ºJSONæ ¼å¼
                    exportWeatherDataAsJSON();
                }
            }
            
            // å¯¼å‡ºä¸ºJSONæ ¼å¼
            function exportWeatherDataAsJSON() {
                if (!currentAnalysisData && !currentWeatherData) {
                    alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆè¿›è¡Œåˆ†æ');
                    return;
                }
                
                // åˆ›å»ºå¯¼å‡ºæ•°æ®å¯¹è±¡
                const exportData = {
                    exportDate: new Date().toISOString(),
                    city: config.currentCity,
                    analysisSummary: document.getElementById('analysisSummary').innerText,
                    detailedAnalysis: document.getElementById('detailedAnalysis').innerText,
                    weatherData: currentWeatherData,
                    predictionData: currentPredictionData,
                    
                    // è·å–å›¾è¡¨æ•°æ®
                    temperatureChartData: getChartData('temperatureChart'),
                    precipitationChartData: getChartData('precipitationChart')
                };
                
                // å°†æ•°æ®è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                const jsonData = JSON.stringify(exportData, null, 2);
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([jsonData], { type: 'application/json;charset=utf-8;' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${config.currentCity.name}_å¤©æ°”åˆ†æ_${new Date().toISOString().split('T')[0]}.json`;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // è·å–å›¾è¡¨æ•°æ®
            function getChartData(chartId) {
                const chart = echarts.getInstanceByDom(document.getElementById(chartId));
                if (!chart) return null;
                
                const option = chart.getOption();
                const series = option.series || [];
                const xAxis = option.xAxis && option.xAxis[0] ? option.xAxis[0].data : [];
                
                const chartData = {
                    dates: xAxis,
                    series: series.map(s => ({
                        name: s.name,
                        data: s.data
                    }))
                };
                
                return chartData;
            }
            
            // å¯¼å‡ºå¤©æ°”æ•°æ®ä¸ºCSVæ ¼å¼
            function exportWeatherDataAsCSV() {
                if (!currentWeatherData) {
                    alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆè¿›è¡Œåˆ†æ');
                    return;
                }
                
                // CSVè¡¨å¤´
                const headers = ['æ—¥æœŸ', 'æœ€é«˜æ¸©åº¦(Â°C)', 'æœ€ä½æ¸©åº¦(Â°C)', 'é™æ°´é‡', 'æ¹¿åº¦', 'æ°”å‹'];
                
                // ç”ŸæˆCSVå†…å®¹
                let csvContent = headers.join(',') + '\n';
                
                currentWeatherData.forEach(item => {
                    const row = [
                        item.fxDate,
                        item.tempMax,
                        item.tempMin,
                        item.precip || '',
                        item.humidity || '',
                        item.pressure || ''
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // å¦‚æœæœ‰é¢„æµ‹æ•°æ®ï¼Œä¹Ÿæ·»åŠ åˆ°CSV
                if (currentPredictionData && currentPredictionData.length > 0) {
                    csvContent += '\n\né¢„æµ‹æ•°æ®\n';
                    csvContent += headers.join(',') + '\n';
                    
                    currentPredictionData.forEach(item => {
                        const row = [
                            item.fxDate,
                            item.tempMax,
                            item.tempMin,
                            item.precip || '',
                            '', // æ¹¿åº¦å ä½
                            ''  // æ°”å‹å ä½
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                }
                
                // æ·»åŠ UTF-8 BOMä»¥ç¡®ä¿Excelæ­£ç¡®è¯†åˆ«ä¸­æ–‡å­—ç¬¦
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${config.currentCity.name}_å¤©æ°”æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
    <!-- å’Œé£å¤©æ°”æœåŠ¡å½’å›  -->
    <footer class="bg-gray-100 p-4 text-center text-sm text-gray-600 mt-8">
        <p>å¤©æ°”æœåŠ¡ç”± <a href="https://www.qweather.com" target="_blank" class="text-blue-600 hover:underline">å’Œé£å¤©æ°”</a> é©±åŠ¨</p>
    </footer>
</body>
</html>